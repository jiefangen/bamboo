<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.panda.business.admin.modules.monitor.dao.ActionLogDao">
    <sql id="logColumns"> action_type, content, ip_address, username, operating_time, elapsed_time, status_code, exception_info </sql>

    <resultMap id="baseLogMap" type="org.panda.business.admin.modules.monitor.domain.ActionLog">
        <id column="log_id" property="id" jdbcType="BIGINT"/>
        <result column="action_type" property="actionType" jdbcType="INTEGER"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="ip_address" property="ipAddress" jdbcType="VARCHAR"/>
        <result column="username" property="username" jdbcType="VARCHAR"/>
        <result column="operating_time" property="operatingTime" jdbcType="TIMESTAMP"/>
        <result column="elapsed_time" property="elapsedTime" jdbcType="INTEGER"/>
        <result column="status_code" property="statusCode" jdbcType="INTEGER"/>
        <result column="exception_info" property="exceptionInfo" jdbcType="VARCHAR"/>
    </resultMap>

    <select id="findLogPage" resultMap="baseLogMap">
        SELECT
        id log_id,
        <include refid="logColumns"/>
        FROM sys_action_log
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <if test="keyword != null and keyword != ''">
                or username like CONCAT('%',#{keyword,jdbcType=VARCHAR},'%')
                or ip_address like CONCAT('%',#{keyword,jdbcType=VARCHAR},'%')
            </if>
        </trim>
        ORDER BY operating_time desc
    </select>

    <insert id="insertLog">
        insert into sys_action_log (<include refid="logColumns"/>)
            values(#{log.actionType}, #{log.content}, #{log.ipAddress}, #{log.username},
                   #{log.operatingTime}, #{log.elapsedTime}, #{log.statusCode}, #{log.exceptionInfo})
    </insert>

    <delete id="truncateLog">
        truncate table sys_action_log
    </delete>

    <!-- '<='替换&lt;= '>='替换&gt;= -->
    <delete id="deleteLogByTime">
        delete from sys_action_log where operating_time &lt; NOW() - INTERVAL #{intervalDay} DAY
    </delete>
</mapper>